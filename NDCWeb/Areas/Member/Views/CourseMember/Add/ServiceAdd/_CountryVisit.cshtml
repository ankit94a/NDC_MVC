@*<div class="card mt-4">
        <div class="card-header" style="background-color:#fff">
            COUNTRIES VISITED
        </div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <Label class="control-label">Name of Country</Label>
                    <select class="form-control" id="cvCountry_1" name="cvCountry">
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <Label class="control-label">Year of Visit</Label>
                    <input type="text" name="cvVisit" id="cvVisit_1" title="Enter Visit" class="form-control" placeholder="Year of Visit">
                </div>
                <div class="form-group col-md-2">
                    <Label class="control-label">Stay Duration</Label>
                    <input type="text" name="cvDuration" id="cvDuration_1" title="Enter Stay Duration" class="form-control" placeholder="Stay Duration">
                </div>
                <div class="form-group col-md-4">
                    <Label class="control-label">Purpose</Label>
                    <input type="text" name="cvPurpose" id="cvPurpose_1" title="Enter Purpose" class="form-control" placeholder="Purpose">
                </div>
                <div class="form-group col-md-1">
                    <Label class="control-label pb-1" style="width:100%"></Label>
                    <button type="button" class="add-CountryVisit btn btn-outline-primary btn-sm"><i class="fa fa-plus"></i></button>
                    <button type="button" class="remove-CountryVisit btn btn-outline-danger ml-2 btn-sm"><i class="fa fa-minus"></i></button>
                </div>
            </div>
            <div id="new_cv"></div>
            <input type="hidden" value="1" id="total_cv">

        </div>
    </div>
    <script>
        $(document).ready(function () {
            getddlCountryName('#cvCountry_1');
            loadPurposeSuggestion();
        });
        // #region Country Visit
        function storeCountryVisit() {
            let ttlcv = $('#total_cv').val();
            let countryVisits = [];
            for (i = 1, j = 0; i <= ttlcv; i++, j++) {
                countryVisits[j] = {
                    Country: $('#cvCountry_' + i).val(),
                    Visit: $('#cvVisit_' + i).val(),
                    Duration: $('#cvDuration_' + i).val(),
                    Purpose: $('#cvPurpose_' + i).val(),
                    //Month: $('#cvMonth_' + i).val(),
                };
            }
            return countryVisits;
        }

        $('.add-CountryVisit').on('click', addCountryVisit);
        $('.remove-CountryVisit').on('click', removeCountryVisit);
        function addCountryVisit() {
            let new_cv_no = parseInt($('#total_cv').val()) + 1;
            let new_inputCv = `<div id="Country_${new_cv_no}" class="form-row">
                                   <div class="form-group col-md-3">
                                        <select class="form-control" id="cvCountry_${new_cv_no}" required name="cvCountry">
                                        </select>
                                   </div>
                                   <div class="form-group col-md-2">
                                       <input type="text" name="cvVisit" id="cvVisit_${new_cv_no}" required title="Enter Visit" class="form-control" placeholder="Visit">
                                   </div>
                                   <div class="form-group col-md-2">
                                       <input type="text" name="cvDuration" id="cvDuration_${new_cv_no}" required title="Enter Duration" class="form-control" placeholder="Duration">
                                   </div>

                                   <div class="form-group col-md-4">
                                       <input type="text" name="cvPurpose" id="cvPurpose_${new_cv_no}" required title="Enter Purpose" class="form-control" placeholder="Purpose">
                                   </div>
                               </div>`
            $('#new_cv').append(new_inputCv);
            $('#total_cv').val(new_cv_no);
            getddlCountryName('#cvCountry_' + new_cv_no);
            loadPurposeSuggestion();
        }
        function removeCountryVisit() {
            let last_cv_no = $('#total_cv').val();

            if (last_cv_no > 1) {
                $('#Country_' + last_cv_no).remove();
                $('#total_cv').val(last_cv_no - 1);
            }
        }
        // #endregion


        function addMemberCountryVisits() {
            if ($("#formCMCountryVisit").valid()) {
                let countryVisitList = storeCountryVisit();
                let countryVisits = JSON.stringify(countryVisitList);
                $.ajax({
                    type: 'post',
                    url: '/api/courseMembers/CountryVisit',
                    data: countryVisits,
                    contentType: "application/json; charset=utf-8",
                    datatype: 'json',
                    success: function (data, textStatus, xhr) {
                        toastr.info(textStatus);
                        displayTab('ServicePartial');
                    },
                    error: function () {
                        toastr.error('Operation Failed!');
                    }
                });
            }
        }
    </script>*@
<div class="card mt-4 p-3">
    <div class="card-header bg-white font-weight-bold">
        COUNTRIES VISITED
    </div>
    <div class="card-body">
        <table class="table table-bordered table-sm" id="countryVisitTable">
            <thead class="thead-light">
                <tr>
                    <th>Country</th>
                    <th>Year of Visit</th>
                    <th>Stay Duration</th>
                    <th>Purpose</th>
                    <th style="width: 90px;">Action</th>
                </tr>
            </thead>
            <tbody id="countryVisitBody">
                <tr id="cv_row_1">
                    <td>
                        <select class="form-control" id="cvCountry_1" name="cvCountry"></select>
                    </td>
                    <td>
                        <input type="text" name="cvVisit" id="cvVisit_1" title="Enter Visit" class="form-control" placeholder="Year of Visit">
                    </td>
                    <td>
                        <input type="text" name="cvDuration" id="cvDuration_1" title="Enter Duration" class="form-control" placeholder="Stay Duration">
                    </td>
                    <td>
                        <input type="text" name="cvPurpose" id="cvPurpose_1" title="Enter Purpose" class="form-control" placeholder="Purpose">
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm add-CountryVisit"><i class="fa fa-plus"></i></button>
                    </td>
                </tr>
            </tbody>
        </table>
        <input type="hidden" value="1" id="total_cv">
    </div>
</div>

<script>

    $(document).ready(function () {
        getddlCountryName('#cvCountry_1');
        loadPurposeSuggestion();
    });

    function storeCountryVisit() {
        let ttlcv = $('#total_cv').val();
        let countryVisits = [];

        for (let i = 1; i <= ttlcv; i++) {
            if ($(`#cv_row_${i}`).length) {
                countryVisits.push({
                    Country: $(`#cvCountry_${i}`).val(),
                    Visit: $(`#cvVisit_${i}`).val(),
                    Duration: $(`#cvDuration_${i}`).val(),
                    Purpose: $(`#cvPurpose_${i}`).val()
                });
            }
        }
        return countryVisits;
    }

    // Delegated events for dynamic add/remove
    $('#countryVisitTable').on('click', '.add-CountryVisit', function () {
        let total = parseInt($('#total_cv').val());
        let newId = total + 1;

        let newRow = `<tr id="cv_row_${newId}">
    <td><select class="form-control" id="cvCountry_${newId}" name="cvCountry"></select></td>
    <td><input type="text" name="cvVisit" id="cvVisit_${newId}" title="Enter Visit" class="form-control" placeholder="Year of Visit"></td>
    <td><input type="text" name="cvDuration" id="cvDuration_${newId}" title="Enter Duration" class="form-control" placeholder="Stay Duration"></td>
    <td><input type="text" name="cvPurpose" id="cvPurpose_${newId}" title="Enter Purpose" class="form-control" placeholder="Purpose"></td>
    <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm remove-CountryVisit"><i class="fa fa-minus"></i></button>
        <button type="button" class="btn btn-outline-primary btn-sm add-CountryVisit"><i class="fa fa-plus"></i></button>
    </td>
</tr>`;

        $('#countryVisitBody').append(newRow);
        $('#total_cv').val(newId);

        // Update previous row's action buttons (remove-only)
        if (newId > 1) {
            let prevRow = $(`#cv_row_${newId - 1} td:last`);
            prevRow.html(`<button type="button" class="btn btn-outline-danger btn-sm remove-CountryVisit"><i class="fa fa-minus"></i></button>`);
        }

        getddlCountryName('#cvCountry_' + newId);
        loadPurposeSuggestion();
    });

    $('#countryVisitTable').on('click', '.remove-CountryVisit', function () {
        let row = $(this).closest('tr');
        let rowId = row.attr('id').split('_')[2];
        row.remove();

        let rows = $('#countryVisitBody tr');
        $('#total_cv').val(rows.length);

        if (rows.length > 0) {
            let lastRow = rows.last();
            let lastId = lastRow.attr('id').split('_')[2];
            lastRow.find('td:last').html(`
<button type="button" class="btn btn-outline-danger btn-sm remove-CountryVisit"><i class="fa fa-minus"></i></button>
<button type="button" class="btn btn-outline-primary btn-sm add-CountryVisit"><i class="fa fa-plus"></i></button>
            `);
        }
    });

    function addMemberCountryVisits() {
        if ($("#formCMCountryVisit").valid()) {
            let countryVisitList = storeCountryVisit();
            let countryVisits = JSON.stringify(countryVisitList);
            $.ajax({
                type: 'post',
                url: '/api/courseMembers/CountryVisit',
                data: countryVisits,
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) {
                    toastr.info(textStatus);
                    displayTab('ServicePartial');
                },
                error: function () {
                    toastr.error('Operation Failed!');
                }
            });
        }
    }
    function loadPurposeSuggestion() {
        $("input[name='cvPurpose']").autocomplete({
            source: ["Persoal", "Official"],
            minLength: 0
        }).focus(function () {
            $(this).autocomplete('search', "")
        });
    }
</script>
